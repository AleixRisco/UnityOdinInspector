<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity Odin Inspector Visualizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --app-bg: #1a1a1f;
    --panel-bg: #22222a;
    --editor-bg: #16161c;
    --accent: #e8a020;
    --accent2: #4a9eff;
    --text: #d4d4d8;
    --muted: #71717a;
    --border: #333340;

    --u-bg: #282828;
    --u-box: #383838;
    --u-input: #3d3d3d;
    --u-input-border: #1a1a1a;
    --u-label: #bdbdbd;
    --u-bold-header: #ececec;
    --u-orange: #e8922b;
    --u-toggle-on: #4a9eff;
    --u-separator: #222222;
    --u-title-bg: #333333;
    --u-foldout-bg: #2f2f2f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--app-bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Top Bar â”€â”€ */
  .topbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 9px 20px;
    background: var(--panel-bg);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .topbar-logo { font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; }
  .topbar-logo span { color: var(--text); }
  .topbar-subtitle { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .topbar-sep { width: 1px; height: 22px; background: var(--border); flex-shrink: 0; }
  .topbar-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }

  .btn {
    padding: 6px 14px;
    border-radius: 5px; border: none; cursor: pointer;
    font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 13px; letter-spacing: 0.4px;
    transition: all 0.14s;
    display: flex; align-items: center; gap: 5px;
  }
  .btn-primary { background: var(--accent); color: #111; }
  .btn-primary:hover { background: #f0ab35; transform: translateY(-1px); }
  .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-upload { background: #1e2e3e; color: #6db8f0; border: 1px solid #2a4a6a; }
  .btn-upload:hover { background: #2a3e50; border-color: #6db8f0; }

  #fileInput { display: none; }

  .file-badge {
    display: none; align-items: center; gap: 6px;
    padding: 4px 10px;
    background: #1e2e1e; border: 1px solid #3a5a3a; border-radius: 4px;
    font-size: 11px; color: #80c080; font-family: 'JetBrains Mono', monospace;
    max-width: 200px; overflow: hidden;
  }
  .file-badge.visible { display: flex; }
  .file-badge-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
  .file-badge-x { cursor: pointer; opacity: 0.6; flex-shrink: 0; }
  .file-badge-x:hover { opacity: 1; }

  /* â”€â”€ Main Layout â”€â”€ */
  .main { display: grid; grid-template-columns: 1fr 1fr; flex: 1; overflow: hidden; }

  .editor-panel { display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow: hidden; }
  .panel-header {
    padding: 7px 16px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px;
    color: var(--muted); background: var(--panel-bg); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px; flex-shrink: 0;
  }
  .panel-header .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); display: inline-block; }
  .editor-wrap { flex: 1; overflow: hidden; }
  #codeEditor {
    width: 100%; height: 100%;
    background: var(--editor-bg); border: none; outline: none;
    color: #cdd6f4; font-family: 'JetBrains Mono', monospace;
    font-size: 12.5px; line-height: 1.7; padding: 16px;
    resize: none; tab-size: 4; white-space: pre; overflow: auto;
  }

  .preview-panel { display: flex; flex-direction: column; overflow: hidden; background: var(--app-bg); }
  .preview-scroll {
    flex: 1; overflow-y: auto; padding: 24px;
    display: flex; flex-direction: column; align-items: center;
  }
  .preview-scroll::-webkit-scrollbar { width: 6px; }
  .preview-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ Unity Inspector â”€â”€ */
  #unity-preview {
    width: 320px;
    background: var(--u-bg);
    font-family: -apple-system, 'SF Pro Text', 'SF Pro Display', BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    font-size: 12px; color: var(--u-label);
    user-select: none; border: 1px solid #1a1a1a; border-radius: 2px; overflow: hidden;
  }

  .u-component-header {
    background: #333; padding: 4px 8px 4px 6px;
    display: flex; align-items: center; gap: 6px;
    border-bottom: 1px solid #1a1a1a; min-height: 22px;
  }
  .u-arrow { width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid #ababab; flex-shrink:0; }
  .u-component-icon {
    width:16px; height:16px; background:#5c8fa0; border-radius:2px;
    flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:9px; color:white; font-weight:bold;
  }
  .u-component-name { font-size:12px; color:#dfdfdf; font-weight:400; flex:1; }
  .u-component-menu { color:#888; font-size:14px; cursor:pointer; }

  .u-script-row {
    display:flex; align-items:center; padding:2px 6px;
    background:#2e2e2e; border-bottom:1px solid #222; min-height:20px; gap:4px;
  }
  .u-script-label { width:120px; color:#aaa; font-size:11px; flex-shrink:0; }
  .u-script-value {
    flex:1; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    padding:1px 5px; font-size:11px; color:#82c4e0; height:18px; display:flex; align-items:center;
  }

  .u-box { margin:4px 6px; border:1px solid #2a2a2a; border-radius:2px; overflow:hidden; }
  .u-box-title {
    background:var(--u-title-bg); padding:3px 8px; font-size:11px; font-weight:700;
    color:var(--u-bold-header); text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid #222;
  }
  .u-box-content { background:var(--u-box); }

  .u-foldout { margin:2px 0; border-bottom:1px solid var(--u-separator); }
  .u-foldout-header {
    background:var(--u-foldout-bg); padding:3px 6px;
    display:flex; align-items:center; gap:5px; cursor:pointer; border-bottom:1px solid #222;
  }
  .u-foldout-title { font-size:11px; color:#cfcfcf; font-weight:600; }

  .u-field {
    display:flex; align-items:center; min-height:20px;
    padding:1px 6px; border-bottom:1px solid var(--u-separator);
  }
  .u-field:last-child { border-bottom:none; }
  .u-field-label {
    width:120px; min-width:120px; color:var(--u-label); font-size:11px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0;
  }
  .u-field-value { flex:1; min-height:18px; display:flex; align-items:center; }

  .u-input-text {
    width:100%; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    padding:1px 5px; font-size:11px; color:#ddd; height:18px; display:flex; align-items:center;
    font-family: -apple-system, 'SF Pro Text', 'SF Pro Display', BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
  }
  .u-input-number {
    width:100%; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    padding:1px 5px; font-size:11px; color:#ddd; height:18px; display:flex; align-items:center;
  }
  .u-input-bool {
    width:14px; height:14px; background:var(--u-input); border:1px solid var(--u-input-border);
    border-radius:2px; display:flex; align-items:center; justify-content:center; font-size:10px; color:var(--u-toggle-on);
  }
  .u-input-image { display:flex; align-items:center; gap:4px; flex:1; }
  .u-img-box {
    width:18px; height:18px; background:var(--u-input); border:1px solid var(--u-input-border);
    border-radius:2px; display:flex; align-items:center; justify-content:center; font-size:9px; color:#888;
  }
  .u-img-name { color:var(--u-orange); font-size:11px; flex:1; }
  .u-img-btn {
    width:16px; height:16px; background:var(--u-input); border:1px solid var(--u-input-border);
    border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:8px; color:#888;
  }
  .u-input-dropdown {
    flex:1; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    padding:1px 5px; font-size:11px; color:#ddd; height:18px; display:flex; align-items:center; justify-content:space-between;
  }
  .u-dropdown-arrow { color:#888; font-size:8px; }
  .u-input-color { display:flex; align-items:center; gap:4px; flex:1; }
  .u-color-swatch { width:40px; height:18px; background:#fff; border:1px solid var(--u-input-border); border-radius:2px; }
  .u-color-hex {
    flex:1; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    padding:1px 5px; font-size:11px; color:#ddd; height:18px; display:flex; align-items:center;
  }
  .u-input-vector { display:flex; gap:3px; flex:1; }
  .u-vec-field {
    flex:1; background:var(--u-input); border:1px solid var(--u-input-border); border-radius:2px;
    height:18px; display:flex; align-items:center; padding:0 4px; font-size:11px; color:#ddd; gap:2px;
  }
  .u-vec-label { color:#e06060; font-size:9px; font-weight:bold; }
  .u-vec-label.y { color:#60e080; }
  .u-vec-label.z { color:#6090e0; }

  .u-section-header {
    padding:4px 6px 2px; font-size:11px; font-weight:700; color:#cfcfcf;
    border-bottom:1px solid var(--u-separator); background:var(--u-foldout-bg);
    text-transform:uppercase; letter-spacing:0.3px;
  }
  .u-infobox {
    margin:3px 6px; background:#2c3a2c; border:1px solid #3a5a3a; border-radius:2px;
    padding:4px 6px; font-size:10px; color:#90c090; display:flex; gap:5px; align-items:flex-start;
  }
  .u-infobox.warn { background:#3a3020; border-color:#5a4a20; color:#c0a060; }
  .u-infobox.error { background:#3a2020; border-color:#5a2020; color:#c06060; }
  .u-infobox-icon { flex-shrink:0; }

  .u-list-header {
    display:flex; align-items:center; gap:4px;
    padding:2px 6px; border-bottom:1px solid var(--u-separator); background:#2d2d2d;
  }
  .u-list-title { font-size:11px; color:#cfcfcf; flex:1; }
  .u-list-size {
    font-size:10px; color:#888; background:var(--u-input); border:1px solid var(--u-input-border);
    border-radius:2px; padding:1px 4px; height:16px; display:flex; align-items:center;
  }
  .u-list-item {
    display:flex; align-items:center;
    padding:1px 6px 1px 16px; border-bottom:1px solid var(--u-separator); background:#2a2a2a;
  }
  .u-list-item-label { color:#888; font-size:10px; width:60px; flex-shrink:0; }

  .u-space { height:8px; border-bottom:1px solid var(--u-separator); }
  .u-required { color:#e05050; font-size:9px; margin-left:2px; }
  .u-readonly .u-input-text,
  .u-readonly .u-input-number { opacity:0.6; }

  .u-hint {
    padding:24px 16px; font-size:12px; color:var(--muted);
    text-align:center; font-family:'JetBrains Mono',monospace; line-height:2;
  }
  .u-error {
    margin:8px; padding:8px; background:#2a1515; border:1px solid #5a2020;
    border-radius:4px; font-size:11px; color:#e08080; font-family:'JetBrains Mono',monospace; white-space:pre-wrap;
  }

  .export-bar {
    padding:9px 20px; display:flex; gap:8px; align-items:center;
    border-top:1px solid var(--border); flex-shrink:0;
  }
  .export-bar > span { font-size:13px; color:var(--muted); }
  .scale-ctrl { display:flex; align-items:center; gap:8px; margin-left:auto; }
  .scale-ctrl label { font-size:12px; color:var(--muted); }
  .scale-ctrl select {
    background:var(--panel-bg); border:1px solid var(--border); color:var(--text);
    padding:4px 8px; border-radius:4px; font-family:'Rajdhani',sans-serif; font-size:13px;
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">Odin<span>Vis</span></div>
  <div class="topbar-subtitle">Unity Inspector Preview</div>
  <div class="topbar-sep"></div>

  <div class="file-badge" id="fileBadge">
    <span>ğŸ“„</span>
    <span class="file-badge-name" id="fileBadgeName"></span>
    <span class="file-badge-x" id="fileClear">âœ•</span>
  </div>

  <div class="topbar-actions">
    <input type="file" id="fileInput" accept=".cs">
    <button class="btn btn-upload" id="uploadBtn">ğŸ“‚ Abrir .cs</button>
    <div class="topbar-sep"></div>
    <button class="btn btn-secondary" id="loadSample">Ejemplo</button>
    <button class="btn btn-secondary" id="clearBtn">Limpiar</button>
    <button class="btn btn-primary" id="parseBtn">â–¶ Previsualizar</button>
  </div>
</div>

<div class="main">
  <div class="editor-panel">
    <div class="panel-header"><span class="dot"></span>C# â€” Editor</div>
    <div class="editor-wrap">
      <textarea id="codeEditor" spellcheck="false"
        placeholder="// Escribe o carga un archivo .cs de Unity con Odin Inspector...&#10;// Ctrl+Enter para previsualizar al instante"></textarea>
    </div>
  </div>

  <div class="preview-panel">
    <div class="panel-header"><span class="dot" style="background:var(--accent2)"></span>Unity Inspector â€” Preview</div>
    <div class="preview-scroll">
      <div id="unity-preview">
        <div class="u-hint">
          Escribe cÃ³digo C# o carga un archivo <strong style="color:#6db8f0">.cs</strong><br>
          y presiona <strong style="color:var(--accent)">â–¶ Previsualizar</strong><br>
          <span style="font-size:10px;color:#444;margin-top:8px;display:block">Ctrl+Enter para preview rÃ¡pido</span>
        </div>
      </div>
    </div>
    <div class="export-bar">
      <span>Exportar:</span>
      <button class="btn btn-secondary" id="savePNG">â¬‡ PNG</button>
      <div class="scale-ctrl">
        <label>Escala:</label>
        <select id="scaleSelect">
          <option value="1">1x</option>
          <option value="2" selected>2x</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
        </select>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLE_CODE = `[CreateAssetMenu(menuName = "Action Damage SO)]
public class ActionDamageSO : ScriptableObject
{
        [TitleGroup("VALUE")]
        [LabelText("Action Value")] public Action Value SO target;
        [TitleGroup("DAMAGE")]
        [LabelText("Defense Ignore")] public bool defenseIgnore;
        [LabelText("Critical Hit")] public bool criticalHit;
        [LabelText("Hit Count")] public bool hitCount;
        [Indent(1)][LabelText("Min")] [ShowIf("hitCount")] public int minHits;
        [Indent(1)][LabelText("Max")] [ShowIf("hitCount")] public int maxHits;

        [TitleGroup("TARGET")]
        [LabelText("Action Target")] public Action Target SO target;
}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseCode(code) {
  const result = { className: '', menuName: '', fields: [], enums: {} };

  // Strip block and line comments
  code = code.replace(/\/\*[\s\S]*?\*\//g, '').replace(/\/\/[^\n]*/g, '');

  // Enums (anywhere)
  const enumRx = /(?:public\s+)?enum\s+(\w+)\s*\{([^}]+)\}/g;
  let em;
  while ((em = enumRx.exec(code)) !== null) {
    const vals = em[2].split(',')
      .map(v => v.trim().replace(/\s*=\s*\d+/, '').trim())
      .filter(Boolean);
    result.enums[em[1]] = vals;
  }

  // Class name (first class/struct)
  const classMatch = code.match(/(?:public|internal)?\s*(?:partial\s+)?class\s+(\w+)/);
  if (classMatch) result.className = classMatch[1];

  const menuMatch = code.match(/menuName\s*=\s*"([^"]+)"/);
  if (menuMatch) result.menuName = menuMatch[1];

  // â”€â”€ Walk through code tracking brace depth â”€â”€
  // Only collect fields at class body depth (depth == 1)
  const lines = code.split('\n');
  let depth = 0;
  let inClass = false;
  let pendingAttrs = [];
  let lastGroup = null;
  let lastGroupType = null;

  for (let i = 0; i < lines.length; i++) {
    const raw = lines[i];
    const t = raw.trim();

    // Count braces to track depth
    const opens = (raw.match(/\{/g) || []).length;
    const closes = (raw.match(/\}/g) || []).length;

    // Detect class body start
    if (!inClass && /\bclass\b|\bstruct\b/.test(t)) {
      inClass = true;
    }

    const prevDepth = depth;
    depth += opens - closes;

    // Skip if not inside class or at wrong depth
    // Class-level = depth 1 (after the class { opens it)
    if (!inClass) { continue; }

    // We only care about lines where the effective depth during that line is 1
    // (depth went from 0->1 on class { line, so class members are at depth 1)
    const effectiveDepth = Math.max(prevDepth, depth);
    if (effectiveDepth > 1) {
      // Inside method or nested block â€” reset attrs
      if (opens === 0 && closes === 0) pendingAttrs = [];
      continue;
    }

    if (!t) continue;

    // â”€â”€ Attribute lines â”€â”€
    if (t.startsWith('[')) {
      const attrTokens = t.match(/\[[^\]]+\]/g) || [];
      for (const a of attrTokens) {
        if (/^\[(?:CreateAssetMenu|Serializable|RequireComponent|AddComponentMenu|DisallowMultipleComponent)/.test(a)) continue;
        pendingAttrs.push(a);
      }
      // Inline field after attributes on same line?
      const rest = t.replace(/\[[^\]]+\]/g, '').trim();
      if (rest && /(?:public|private|protected)/.test(rest) && rest.endsWith(';')) {
        const f = tryAddField(rest, pendingAttrs, result);
        if (f) updateGroupState(f);
        pendingAttrs = [];
      }
      continue;
    }

    // â”€â”€ Field declaration â”€â”€
    if (/(?:public|private|protected|internal)/.test(t) && t.endsWith(';')) {
      // Not a method (no parentheses for parameter list before the ;)
      // Methods end with ) { or ) ; for abstract
      if (!isMethodSignature(t)) {
        const f = tryAddField(t, pendingAttrs, result);
        if (f) updateGroupState(f);
        pendingAttrs = [];
        continue;
      }
    }

    // Reset attrs on other non-blank lines
    if (t && !t.startsWith('[') && t !== '{' && t !== '}') {
      pendingAttrs = [];
    }
  }

  function updateGroupState(f) {
    if (f.group) {
      lastGroup = f.group;
      lastGroupType = f.groupType;
    } else if (lastGroup) {
      f.group = lastGroup;
      f.groupType = lastGroupType;
    }
  }

  return result;
}

function isMethodSignature(line) {
  // Has () â†’ likely a method
  // But field with default values like = new List<string>() is also valid
  // Rule: if there's a ( before the last ; that looks like params, it's a method
  const noStrings = line.replace(/"[^"]*"/g, '""');
  // Property: has { get or { set
  if (/\{\s*get|\{\s*set/.test(noStrings)) return true;
  // Abstract/virtual method ending in ;
  if (/\b(void|async|Task|UniTask|IEnumerator)\b/.test(noStrings)) return true;
  // Has ( ) that isn't part of = new ...()
  const hasMethodParens = /\w\s*\([^)]*\)\s*;/.test(noStrings) && !/=\s*new\s/.test(noStrings);
  return hasMethodParens;
}

function tryAddField(line, pendingAttrs, result) {
  const rx = /(?:public|private|protected|internal)\s+(?:(?:readonly|static|new|override|virtual|abstract)\s+)*(.+?)\s+(\w+)\s*(?:=\s*(.+?))?;$/;
  const m = line.trim().match(rx);
  if (!m) return null;

  const typeFull = m[1].trim();
  const name = m[2];
  const defaultVal = m[3] ? m[3].trim().replace(/f$/, '').replace(/"/g, '') : null;

  // Visibility filter: private needs [SerializeField]
  const isPublic = /^\s*(public)\s/.test(line);
  const hasSF = pendingAttrs.some(a => /SerializeField/.test(a));
  if (!isPublic && !hasSF) return null;

  // Skip events/delegates/actions
  if (/\bdelegate\b|\bevent\b/.test(typeFull)) return null;

  const field = {
    type: typeFull,
    name: name,
    defaultValue: defaultVal,
    attrs: [...pendingAttrs],
    label: toLabel(name),
    group: null, groupType: null,
    hideLabel: false, required: false, readOnly: false,
    previewField: false, infoBox: null, infoBoxType: 'info',
    space: false, enumToggle: false, header: null
  };

  for (const attr of field.attrs) {
    let mm;

    mm = attr.match(/BoxGroup\("([^"]+)"\)/i);
    if (mm) { field.group = mm[1]; field.groupType = 'box'; }

    mm = attr.match(/TitleGroup\("([^"]+)"\)/i);
    if (mm) { field.group = mm[1]; field.groupType = 'title'; }

    mm = attr.match(/FoldoutGroup\("([^"]+)"\)/i);
    if (mm) { field.group = mm[1]; field.groupType = 'foldout'; }

    mm = attr.match(/(?:TabGroup|HorizontalGroup|VerticalGroup)\("([^"]*)"\)/i);
    if (mm) { field.group = mm[1] || 'Group'; field.groupType = 'box'; }

    mm = attr.match(/LabelText\("([^"]+)"\)/i);
    if (mm) field.label = mm[1];

    mm = attr.match(/(?:Header|Title)\("([^"]+)"\)/i);
    if (mm) field.header = mm[1];

    if (/HideLabel/.test(attr)) field.hideLabel = true;
    if (/Required/.test(attr)) field.required = true;
    if (/ReadOnly/.test(attr)) field.readOnly = true;
    if (/PreviewField/.test(attr)) field.previewField = true;
    if (/\bSpace\b/.test(attr)) field.space = true;
    if (/EnumToggleButtons/.test(attr)) field.enumToggle = true;

    mm = attr.match(/InfoBox\("([^"]+)"(?:[^)]*InfoMessageType\.(\w+))?\)/i);
    if (mm) { field.infoBox = mm[1]; field.infoBoxType = mm[2] ? mm[2].toLowerCase() : 'info'; }
  }

  result.fields.push(field);
  return field;
}

function toLabel(name) {
  return name
    .replace(/^_+/, '')            // strip leading underscores
    .replace(/([A-Z])/g, ' $1')   // camelCase to words
    .replace(/^./, s => s.toUpperCase())
    .trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTypeIcon(name) {
  const w = (name || 'S').match(/[A-Z][a-z]*/g) || ['S'];
  return (w[0][0] + (w[1] ? w[1][0] : '')).toUpperCase();
}

function renderInspector(parsed) {
  const preview = document.getElementById('unity-preview');
  preview.innerHTML = '';

  if (!parsed.className) {
    preview.innerHTML = '<div class="u-hint">No se encontrÃ³ ninguna clase pÃºblica</div>';
    return;
  }

  const ch = el('div', 'u-component-header');
  ch.innerHTML = `
    <div class="u-arrow"></div>
    <div class="u-component-icon">${getTypeIcon(parsed.className)}</div>
    <div class="u-component-name">${parsed.className}</div>
    <div class="u-component-menu">â‹®</div>`;
  preview.appendChild(ch);

  const sr = el('div', 'u-script-row');
  sr.innerHTML = `<div class="u-script-label">Script</div><div class="u-script-value">${parsed.className}</div>`;
  preview.appendChild(sr);

  if (parsed.fields.length === 0) {
    const n = el('div', 'u-hint');
    n.style.fontSize = '11px';
    n.innerHTML = 'No se encontraron campos serializados.<br><span style="color:#444;font-size:10px">Los campos private necesitan [SerializeField]</span>';
    preview.appendChild(n);
    return;
  }

  const groups = buildGroups(parsed.fields);
  for (const g of groups) {
    if      (g.type === 'none')    for (const f of g.fields) renderField(preview, f, parsed.enums);
    else if (g.type === 'foldout') renderFoldoutGroup(preview, g, parsed.enums);
    else if (g.type === 'title')   renderTitleGroup(preview, g, parsed.enums);
    else                           renderBoxGroup(preview, g, parsed.enums);
  }
}

function buildGroups(fields) {
  const groups = [];
  const map = new Map();
  for (const f of fields) {
    if (!f.group) {
      let g = groups.find(g => g.type === 'none');
      if (!g) { g = { type: 'none', name: '', fields: [] }; groups.push(g); }
      g.fields.push(f);
    } else {
      let g = map.get(f.group);
      if (!g) { g = { type: f.groupType || 'box', name: f.group, fields: [] }; groups.push(g); map.set(f.group, g); }
      g.fields.push(f);
    }
  }
  return groups;
}

function renderBoxGroup(parent, group, enums) {
  const box = el('div', 'u-box');
  const title = el('div', 'u-box-title');
  title.textContent = group.name;
  box.appendChild(title);
  const content = el('div', 'u-box-content');
  for (const f of group.fields) renderField(content, f, enums);
  box.appendChild(content);
  parent.appendChild(box);
}

function renderTitleGroup(parent, group, enums) {
  const wrap = el('div', 'u-foldout');
  wrap.style.margin = '4px 0';
  const hdr = el('div', 'u-foldout-header');
  hdr.style.cssText += 'background:#252535;border-left:3px solid #5555aa;';
  hdr.innerHTML = `<div class="u-arrow"></div><div class="u-foldout-title" style="color:#9999cc">${group.name}</div>`;
  wrap.appendChild(hdr);
  const content = el('div', 'u-box-content');
  for (const f of group.fields) renderField(content, f, enums);
  wrap.appendChild(content);
  parent.appendChild(wrap);
}

function renderFoldoutGroup(parent, group, enums) {
  const wrap = el('div', 'u-foldout');
  const hdr = el('div', 'u-foldout-header');
  hdr.innerHTML = `<div class="u-arrow"></div><div class="u-foldout-title">${group.name}</div>`;
  wrap.appendChild(hdr);
  for (const f of group.fields) renderField(wrap, f, enums);
  parent.appendChild(wrap);
}

function renderField(parent, field, enums) {
  if (field.space) parent.appendChild(el('div', 'u-space'));
  if (field.header) {
    const h = el('div', 'u-section-header'); h.textContent = field.header; parent.appendChild(h);
  }
  if (field.infoBox) {
    const ib = el('div', 'u-infobox' + (field.infoBoxType === 'warning' ? ' warn' : field.infoBoxType === 'error' ? ' error' : ''));
    ib.innerHTML = `<span class="u-infobox-icon">${field.infoBoxType === 'warning' ? 'âš ' : field.infoBoxType === 'error' ? 'âœ–' : 'â„¹'}</span>${field.infoBox}`;
    parent.appendChild(ib);
  }

  const row = el('div', 'u-field' + (field.readOnly ? ' u-readonly' : ''));
  if (!field.hideLabel) {
    const lbl = el('div', 'u-field-label');
    lbl.textContent = field.label;
    if (field.required) { const r = document.createElement('span'); r.className='u-required'; r.textContent=' *'; lbl.appendChild(r); }
    row.appendChild(lbl);
  }
  const vw = el('div', 'u-field-value');
  if (field.hideLabel) vw.style.width = '100%';
  vw.appendChild(renderValue(field, enums));
  row.appendChild(vw);
  parent.appendChild(row);
}

function renderValue(field, enums) {
  const t = field.type.toLowerCase().trim();

  if (/sprite|texture2d|texture/.test(t))
    return field.previewField ? renderImagePreview() : renderImageField(field.defaultValue);

  if (t === 'bool') { const b = el('div','u-input-bool'); b.textContent = field.defaultValue==='true'?'âœ“':''; return b; }

  if (/^(?:int|uint|float|double|long|short|byte)$/.test(t)) {
    const n = el('div','u-input-number'); n.textContent = field.defaultValue||'0'; return n;
  }

  if (t === 'color') {
    const w=el('div','u-input-color'), sw=el('div','u-color-swatch'), hx=el('div','u-color-hex');
    hx.textContent='FFFFFFFF'; w.appendChild(sw); w.appendChild(hx); return w;
  }

  if (t === 'vector2') return renderVector(['X','Y']);
  if (t === 'vector3') return renderVector(['X','Y','Z']);
  if (t === 'vector4') return renderVector(['X','Y','Z','W']);

  if (/^list<|^ilist<|^ienumerable</.test(t)) return renderListField();

  // Enum
  const enumKey = Object.keys(enums).find(k => k.toLowerCase() === t);
  if (enumKey) {
    if (field.enumToggle) return renderEnumToggle(enums[enumKey]);
    const dd = el('div','u-input-dropdown');
    dd.innerHTML = `<span>${enums[enumKey][0]||'None'}</span><span class="u-dropdown-arrow">â–¾</span>`;
    return dd;
  }

  // Known Unity component references
  if (/^(?:gameobject|transform|rigidbody|rigidbody2d|collider|collider2d|animator|camera|audioclip|audiosource|monobehaviour|scriptableobject)$/.test(t)) {
    return renderRefField(field.type);
  }

  // UI components
  if (/^(?:tmp_text|textmeshpro|textmeshprougui|button|image|rawimage|slider|toggle|scrollrect|canvas|rectransform)$/.test(t)) {
    return renderRefField(field.type);
  }

  // Generic PascalCase = likely a class/component reference
  if (/^[A-Z]/.test(field.type.trim()) && !/^string$/i.test(t)) {
    return renderRefField(field.type);
  }

  const inp = el('div','u-input-text'); inp.textContent = field.defaultValue||''; return inp;
}

function renderVector(labels) {
  const w = el('div','u-input-vector');
  labels.forEach((c,i) => {
    const f = el('div','u-vec-field');
    const l = document.createElement('span');
    l.className = 'u-vec-label' + (i===1?' y':i===2?' z':i===3?' z':'');
    l.style.color = i===0?'#e06060':i===1?'#60e080':i===2?'#6090e0':'#aaa';
    l.textContent = c;
    f.appendChild(l); f.appendChild(document.createTextNode('0'));
    w.appendChild(f);
  });
  return w;
}

function renderRefField(typeName) {
  const w = el('div','u-input-image');
  const box = el('div','u-img-box'); box.textContent = 'â—‹'; box.style.color='#5c8fa0';
  const name = el('div','u-img-name'); name.textContent=`None (${typeName})`; name.style.color='#aaa';
  const btn = el('div','u-img-btn'); btn.textContent='â—';
  w.appendChild(box); w.appendChild(name); w.appendChild(btn); return w;
}

function renderImageField(val) {
  const w = el('div','u-input-image');
  const box = el('div','u-img-box'); box.textContent='ğŸ–¼';
  const name = el('div','u-img-name'); name.textContent = val||'[ImageName]';
  const btn = el('div','u-img-btn'); btn.textContent='â—';
  w.appendChild(box); w.appendChild(name); w.appendChild(btn); return w;
}

function renderImagePreview() {
  const w = document.createElement('div');
  w.style.cssText='display:flex;align-items:center;gap:8px;flex:1';
  const pv = document.createElement('div');
  pv.style.cssText='width:50px;height:50px;background:#333;border:1px solid #1a1a1a;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#555;';
  pv.textContent='ğŸ–¼';
  const name = el('div','u-img-name'); name.textContent='[ImageName]';
  w.appendChild(pv); w.appendChild(name); return w;
}

function renderListField() {
  const w = document.createElement('div'); w.style.cssText='flex:1;';
  const hdr = el('div','u-list-header');
  const arr = document.createElement('span'); arr.className='u-arrow'; arr.style.marginRight='3px';
  const title = el('div','u-list-title'); title.textContent='List';
  const size = el('div','u-list-size'); size.textContent='0';
  hdr.appendChild(arr); hdr.appendChild(title); hdr.appendChild(size);
  w.appendChild(hdr);
  const item = el('div','u-list-item');
  const il = el('div','u-list-item-label'); il.textContent='Element 0';
  const inp = el('div','u-input-text'); inp.style.flex='1';
  item.appendChild(il); item.appendChild(inp); w.appendChild(item);
  return w;
}

function renderEnumToggle(values) {
  const w = document.createElement('div');
  w.style.cssText='display:flex;gap:2px;flex:1;flex-wrap:wrap;';
  values.forEach((v,i) => {
    const b = document.createElement('div');
    b.style.cssText=`background:${i===0?'#3a5a8a':'#3a3a3a'};border:1px solid ${i===0?'#5a8aba':'#2a2a2a'};border-radius:2px;padding:1px 6px;font-size:10px;color:${i===0?'#9abfe0':'#888'};`;
    b.textContent = v; w.appendChild(b);
  });
  return w;
}

function el(tag, cls) {
  const d = document.createElement(tag);
  if (cls) d.className = cls;
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('uploadBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('codeEditor').value = ev.target.result;
    document.getElementById('fileBadgeName').textContent = file.name;
    document.getElementById('fileBadge').classList.add('visible');
    triggerParse();
  };
  reader.readAsText(file);
  e.target.value = ''; // allow re-selecting same file
});

document.getElementById('fileClear').addEventListener('click', () => {
  document.getElementById('fileBadge').classList.remove('visible');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerParse() {
  const code = document.getElementById('codeEditor').value;
  if (!code.trim()) return;
  try {
    renderInspector(parseCode(code));
  } catch(e) {
    document.getElementById('unity-preview').innerHTML = `<div class="u-error">Error al parsear:\n${e.message}\n\n${e.stack||''}</div>`;
  }
}

document.getElementById('parseBtn').addEventListener('click', triggerParse);

document.getElementById('codeEditor').addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); triggerParse(); }
  if (e.key === 'Tab') {
    e.preventDefault();
    const ta = e.target, s = ta.selectionStart, end = ta.selectionEnd;
    ta.value = ta.value.substring(0, s) + '    ' + ta.value.substring(end);
    ta.selectionStart = ta.selectionEnd = s + 4;
  }
});

document.getElementById('loadSample').addEventListener('click', () => {
  document.getElementById('codeEditor').value = SAMPLE_CODE;
  document.getElementById('fileBadge').classList.remove('visible');
  triggerParse();
});

document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('codeEditor').value = '';
  document.getElementById('fileBadge').classList.remove('visible');
  document.getElementById('unity-preview').innerHTML = '<div class="u-hint">Escribe cÃ³digo C# o carga un archivo .cs<br>y presiona <strong style="color:var(--accent)">â–¶ Previsualizar</strong></div>';
});

document.getElementById('savePNG').addEventListener('click', async () => {
  const target = document.getElementById('unity-preview');
  const scale = parseFloat(document.getElementById('scaleSelect').value);
  try {
    const canvas = await html2canvas(target, { scale, backgroundColor:'#282828', useCORS:true, logging:false });
    const a = document.createElement('a');

    // Get class name for filename
    const code = document.getElementById('codeEditor').value;
    const parsed = parseCode(code);
    a.download = parsed.className ? (parsed.className + '.png') : 'unity-inspector.png';

    a.href = canvas.toDataURL('image/png');
    a.click();
  } catch(e) { alert('Error al exportar: ' + e.message); }
});

window.addEventListener('load', () => {
  document.getElementById('codeEditor').value = SAMPLE_CODE;
  setTimeout(triggerParse, 100);
});
</script>
</body>
</html>
